name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck on shell scripts
        run: |
          echo "=== ShellCheck Analysis ==="

          FAILED=0
          FOUND=0

          # Use process substitution to avoid word splitting on filenames
          while IFS= read -r script; do
            [ -z "$script" ] && continue
            FOUND=1
            echo ""
            echo "Checking: $script"

            if echo "$script" | grep -q '\.tmpl$'; then
              # Strip Go template syntax before checking
              # Replace {{ ... }} with PLACEHOLDER to avoid parse errors
              sed 's/{{[^}]*}}/PLACEHOLDER/g' "$script" | \
                shellcheck --shell=sh --severity=warning - || FAILED=1
            else
              shellcheck --severity=warning "$script" || FAILED=1
            fi
          done < <(find .chezmoiscripts -type f \( -name "*.sh" -o -name "*.sh.tmpl" \) 2>/dev/null)

          if [ $FOUND -eq 0 ]; then
            echo "No shell scripts found in .chezmoiscripts/"
            exit 0
          fi

          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "ERROR: ShellCheck found issues in one or more scripts"
            exit 1
          fi

          echo "OK: All scripts passed ShellCheck"

  chezmoi-validate:
    name: Chezmoi Validation
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: |
          CHEZMOI_VERSION="2.67.0"
          curl -fsSL "https://github.com/twpayne/chezmoi/releases/download/v${CHEZMOI_VERSION}/chezmoi_${CHEZMOI_VERSION}_linux_amd64.tar.gz" -o /tmp/chezmoi.tar.gz
          tar -xzf /tmp/chezmoi.tar.gz -C /usr/local/bin chezmoi
          chmod +x /usr/local/bin/chezmoi
          rm /tmp/chezmoi.tar.gz

      - name: Validate template syntax
        run: |
          echo "=== Template Syntax Validation ==="

          FAILED=0
          FOUND=0

          # Use process substitution to avoid word splitting on filenames
          while IFS= read -r tmpl; do
            [ -z "$tmpl" ] && continue
            FOUND=1
            echo "Validating: $tmpl"

            # Use chezmoi execute-template to validate syntax
            # Note: This will fail if template syntax is invalid
            if ! chezmoi execute-template --file "$tmpl" > /dev/null 2>&1; then
              echo "ERROR: Invalid template syntax in $tmpl"
              chezmoi execute-template --file "$tmpl" 2>&1 || true
              FAILED=1
            fi
          done < <(find . -name "*.tmpl" -type f 2>/dev/null)

          if [ $FOUND -eq 0 ]; then
            echo "No template files found"
            exit 0
          fi

          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "ERROR: Template validation failed"
            exit 1
          fi

          echo "OK: All templates have valid syntax"

      - name: Run chezmoi doctor
        run: |
          echo "=== Chezmoi Doctor ==="
          chezmoi doctor --no-network || true

      - name: Verify chezmoi configuration
        run: |
          echo "=== Chezmoi Configuration Check ==="

          # Check that managed files can be listed (excluding encrypted)
          echo "Managed files (excluding encrypted):"
          chezmoi managed --include=files --exclude=encrypted 2>/dev/null || true

          echo ""
          echo "OK: Configuration appears valid"

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, chezmoi-validate]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=== CI Results ==="
          echo "ShellCheck: ${{ needs.shellcheck.result }}"
          echo "Chezmoi Validation: ${{ needs.chezmoi-validate.result }}"

          if [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.chezmoi-validate.result }}" != "success" ]; then
            echo ""
            echo "Some checks failed. Please review the logs above."
            exit 1
          fi

          echo ""
          echo "All CI checks passed!"
