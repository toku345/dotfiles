name: Security Checks

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  security:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better security scanning

      - name: Check for plaintext key.txt
        run: |
          echo "Checking for accidentally committed plaintext key.txt..."

          # Check if key.txt exists in the repository (excluding key.txt.age)
          if git ls-files | grep -E '^key\.txt$'; then
            echo "ERROR: Plaintext key.txt found in repository!"
            echo "This file should NEVER be committed. Only key.txt.age (encrypted) should be in the repo."
            exit 1
          fi

          # Check if ~/key.txt or similar patterns exist
          if git ls-files | grep -E 'home.*key\.txt$|^\.?key\.txt$' | grep -v '\.age$'; then
            echo "ERROR: Plaintext key file found in repository!"
            exit 1
          fi

          echo "OK: No plaintext key.txt found"

      - name: Verify age encrypted files
        run: |
          echo "Verifying age encrypted files..."

          # Check that key.txt.age exists
          if ! [ -f "key.txt.age" ]; then
            echo "ERROR: key.txt.age not found!"
            echo "The encrypted age key should be present in the repository."
            exit 1
          fi

          # Verify it's actually encrypted (age files start with "age-encryption.org/v1" or "-----BEGIN AGE ENCRYPTED FILE-----")
          FIRST_LINE=$(head -n 1 key.txt.age)
          if ! echo "$FIRST_LINE" | grep -qE "age-encryption.org/v1|-----BEGIN AGE ENCRYPTED FILE-----"; then
            echo "ERROR: key.txt.age does not appear to be a valid age encrypted file!"
            exit 1
          fi

          echo "OK: key.txt.age is present and appears to be properly encrypted"

          # Check other .age files if they exist
          AGE_FILES=$(git ls-files '*.age' | grep -v '^key\.txt\.age$' || true)
          if [ -n "$AGE_FILES" ]; then
            echo "Checking other .age files..."
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                FIRST_LINE=$(head -n 1 "$file")
                if ! echo "$FIRST_LINE" | grep -qE "age-encryption.org/v1|-----BEGIN AGE ENCRYPTED FILE-----"; then
                  echo "ERROR: $file does not appear to be a valid age encrypted file!"
                  exit 1
                fi
                echo "  OK: $file"
              fi
            done < <(echo "$AGE_FILES")
          fi

      - name: Scan for common secrets
        run: |
          echo "Scanning for common secret patterns..."

          # Install ripgrep for better performance
          sudo apt-get update -qq
          sudo apt-get install -y ripgrep

          SECRETS_FOUND=0

          # AWS Access Keys (exclude encrypted files and documentation)
          if rg -i 'AKIA[0-9A-Z]{16}' --type-not lock --type-not svg -g '!*.age' -g '!**/security.md' 2>/dev/null; then
            echo "ERROR: Found potential AWS Access Key"
            SECRETS_FOUND=1
          fi

          # Private Keys (exclude encrypted files and documentation)
          # Use -e flag to prevent the pattern's leading dashes from being interpreted as flags
          if rg -e '-----BEGIN.*PRIVATE KEY-----' --type-not lock --type-not svg -g '!*.age' -g '!**/security.md' 2>/dev/null; then
            echo "ERROR: Found potential private key"
            SECRETS_FOUND=1
          fi

          # GitHub Personal Access Tokens
          if rg 'ghp_[a-zA-Z0-9]{36}' --type-not lock --type-not svg 2>/dev/null; then
            echo "ERROR: Found potential GitHub Personal Access Token"
            SECRETS_FOUND=1
          fi

          # Generic API keys (basic pattern - warning only due to high false positive rate)
          # Fixed: Use literal space and tab instead of \s which doesn't work in single quotes
          if rg -i 'api[_-]?key[" =:]+[a-zA-Z0-9]{32,}' --type-not lock --type-not svg --type-not json -g '!*.age' -g '!**/security.md' 2>/dev/null; then
            echo "WARNING: Found potential API key pattern (may be false positive)"
            # Don't fail on this one, just warn
          fi

          if [ $SECRETS_FOUND -eq 1 ]; then
            echo ""
            echo "ERROR: Security check failed - Potential secrets found in repository!"
            echo "Please review the findings above and remove any sensitive data."
            exit 1
          fi

          echo "OK: No obvious secrets detected"

      - name: Security check summary
        if: success()
        run: |
          echo ""
          echo "All security checks passed!"
          echo ""
          echo "Checks performed:"
          echo "  - No plaintext key.txt found"
          echo "  - Age encrypted files verified"
          echo "  - No common secret patterns detected"
