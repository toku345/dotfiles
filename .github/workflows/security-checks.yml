name: Security Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  security-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install age
        run: |
          sudo apt-get update
          sudo apt-get install -y age

      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install

      - name: Validate age file format
        run: |
          echo "=== Validating age encrypted files format ==="

          # List all .age files
          echo "Found .age files:"
          ls -la *.age private_dot_config/google_ime/*.age 2>/dev/null || true

          # Simply check if required files exist
          if [ ! -f "key.txt.age" ]; then
            echo "❌ ERROR: key.txt.age not found"
            exit 1
          fi
          echo "✅ key.txt.age exists"

          if [ -f "private_dot_config/google_ime/encrypted_google_ime_dictionary.txt.age" ]; then
            echo "✅ encrypted_google_ime_dictionary.txt.age exists"
          else
            echo "⚠️  WARNING: Google IME dictionary not found (optional)"
          fi

      - name: Verify encrypted files exist
        run: |
          echo "=== Verifying required encrypted files exist ==="

          REQUIRED_FILES=(
            "key.txt.age"
            "private_dot_config/google_ime/encrypted_google_ime_dictionary.txt.age"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ ERROR: Required file not found: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

      - name: Check for accidentally committed plaintext keys
        run: |
          echo "=== Checking for accidentally committed plaintext keys ==="

          FORBIDDEN_PATTERNS=(
            "key.txt"
            "*/key.txt"
            "private_key"
            "*.pem"
          )

          ERROR_FOUND=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if find . -path "./.git" -prune -o -type f -name "$pattern" -print | grep -q .; then
              echo "❌ ERROR: Found potentially sensitive file matching pattern: $pattern"
              find . -path "./.git" -prune -o -type f -name "$pattern" -print
              ERROR_FOUND=1
            fi
          done

          if [ $ERROR_FOUND -eq 1 ]; then
            exit 1
          fi
          echo "✅ No plaintext keys found"

      - name: Verify age public key consistency
        run: |
          echo "=== Verifying age public key consistency ==="

          # Extract recipient from key.txt.age using strings command
          RECIPIENT=$(strings key.txt.age | grep "^age1" | head -n 1 || echo "")

          if [ -z "$RECIPIENT" ]; then
            echo "❌ ERROR: Could not extract recipient from key.txt.age"
            echo "File content sample:"
            strings key.txt.age | head -10
            exit 1
          fi

          echo "Found recipient in key.txt.age: $RECIPIENT"

          # Check if .chezmoi.toml.tmpl contains the same recipient
          if [ -f ".chezmoi.toml.tmpl" ]; then
            if ! grep -q "$RECIPIENT" .chezmoi.toml.tmpl; then
              echo "❌ ERROR: Recipient mismatch between key.txt.age and .chezmoi.toml.tmpl"
              echo "Expected: $RECIPIENT"
              exit 1
            fi
            echo "✅ Public key is consistent with .chezmoi.toml.tmpl"
          fi

          # Check all encrypted files use the same recipient
          for file in private_dot_config/google_ime/encrypted_google_ime_dictionary.txt.age; do
            if [ ! -f "$file" ]; then
              continue
            fi
            FILE_RECIPIENT=$(strings "$file" | grep "^age1" | head -n 1 || echo "")
            if [ -z "$FILE_RECIPIENT" ]; then
              echo "⚠️  WARNING: Could not extract recipient from $file"
              continue
            fi
            if [ "$FILE_RECIPIENT" != "$RECIPIENT" ]; then
              echo "❌ ERROR: $file uses different recipient: $FILE_RECIPIENT"
              exit 1
            fi
            echo "✅ $file uses correct recipient"
          done

      - name: Run git-secrets scan
        run: |
          echo "=== Running git-secrets scan ==="

          # Initialize git-secrets
          git secrets --install

          # Add AWS patterns (default)
          git secrets --register-aws

          # Add custom patterns for common secrets
          git secrets --add 'password\s*=\s*["\047][^"\047]+'
          git secrets --add 'api[_-]?key\s*=\s*["\047][^"\047]+'
          git secrets --add 'secret\s*=\s*["\047][^"\047]+'
          git secrets --add 'token\s*=\s*["\047][^"\047]+'

          # Scan all commits
          git secrets --scan-history || {
            echo "❌ ERROR: git-secrets found potential secrets in commit history"
            exit 1
          }

          echo "✅ git-secrets scan passed"

      - name: Security check summary
        if: success()
        run: |
          echo "================================"
          echo "✅ All security checks passed!"
          echo "================================"
          echo ""
          echo "Checks performed:"
          echo "  ✅ Age file format validation"
          echo "  ✅ Required encrypted files exist"
          echo "  ✅ No plaintext keys committed"
          echo "  ✅ Age public key consistency"
          echo "  ✅ git-secrets scan"
          echo ""
          echo "Note: Full decryption test requires password and should be run locally."
          echo "See: scripts/validate-encryption.sh"
