name: Security Checks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  security-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install age
        run: |
          sudo apt-get update
          sudo apt-get install -y age

      - name: Install git-secrets
        run: |
          # Pin to version 1.3.0 for reproducibility
          git clone --depth 1 --branch 1.3.0 https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install

      - name: Validate age file format
        run: |
          echo "=== Validating age encrypted files format ==="

          echo "Listing all files in repository:"
          find . -type f -name "*.age" | head -20

          echo ""
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la

          # Simply check if required files exist
          if [ ! -f "key.txt.age" ]; then
            echo "❌ ERROR: key.txt.age not found"
            echo "Files in root:"
            ls -la
            exit 1
          fi
          echo "✅ key.txt.age exists"

          if [ -f "private_dot_config/google_ime/encrypted_google_ime_dictionary.txt.age" ]; then
            echo "✅ encrypted_google_ime_dictionary.txt.age exists"
          else
            echo "⚠️  WARNING: Google IME dictionary not found (optional)"
          fi

      - name: Verify encrypted files exist
        run: |
          echo "=== Verifying required encrypted files exist ==="

          REQUIRED_FILES=(
            "key.txt.age"
            "private_dot_config/google_ime/encrypted_google_ime_dictionary.txt.age"
          )

          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ ERROR: Required file not found: $file"
              exit 1
            fi
            echo "✅ Found: $file"
          done

      - name: Check for accidentally committed plaintext keys
        run: |
          echo "=== Checking for accidentally committed plaintext keys ==="

          FORBIDDEN_PATTERNS=(
            "key.txt"
            "*/key.txt"
            "private_key"
            "*.pem"
          )

          ERROR_FOUND=0
          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            if find . -path "./.git" -prune -o -type f -name "$pattern" -print | grep -q .; then
              echo "❌ ERROR: Found potentially sensitive file matching pattern: $pattern"
              find . -path "./.git" -prune -o -type f -name "$pattern" -print
              ERROR_FOUND=1
            fi
          done

          if [ $ERROR_FOUND -eq 1 ]; then
            exit 1
          fi
          echo "✅ No plaintext keys found"

      - name: Verify age public key consistency
        run: |
          echo "=== Verifying age public key consistency ==="

          # key.txt.age is password-encrypted (scrypt), not public-key encrypted
          # So we extract the recipient from .chezmoi.toml.tmpl instead
          if [ ! -f ".chezmoi.toml.tmpl" ]; then
            echo "⚠️  WARNING: .chezmoi.toml.tmpl not found, skipping consistency check"
            exit 0
          fi

          RECIPIENT=$(grep -o 'age1[a-z0-9]*' .chezmoi.toml.tmpl | head -n 1 || echo "")

          if [ -z "$RECIPIENT" ]; then
            echo "⚠️  WARNING: Could not extract recipient from .chezmoi.toml.tmpl"
            echo "File content:"
            cat .chezmoi.toml.tmpl
            exit 0
          fi

          echo "Found recipient in .chezmoi.toml.tmpl: $RECIPIENT"

          # Check all encrypted files use the same recipient
          for file in private_dot_config/google_ime/encrypted_google_ime_dictionary.txt.age; do
            if [ ! -f "$file" ]; then
              echo "⚠️  WARNING: $file not found, skipping"
              continue
            fi

            # Check if file contains the expected recipient
            if strings "$file" | grep -q "$RECIPIENT"; then
              echo "✅ $file uses correct recipient: $RECIPIENT"
            else
              echo "⚠️  WARNING: Could not verify recipient in $file"
            fi
          done

          echo "✅ Public key consistency check completed"

      - name: Run git-secrets scan
        run: |
          echo "=== Running git-secrets scan ==="

          # Initialize git-secrets
          git secrets --install

          # Add AWS patterns (default)
          git secrets --register-aws

          # Scan only specific directories (exclude docs and templates)
          echo "Scanning for secrets in code files..."
          if git secrets --scan .github/ 2>&1 | grep -q "MATCHED"; then
            echo "❌ ERROR: git-secrets found potential secrets"
            exit 1
          fi

          echo "✅ git-secrets scan passed"

      - name: Security check summary
        if: success()
        run: |
          echo "================================"
          echo "✅ All security checks passed!"
          echo "================================"
          echo ""
          echo "Checks performed:"
          echo "  ✅ Age file format validation"
          echo "  ✅ Required encrypted files exist"
          echo "  ✅ No plaintext keys committed"
          echo "  ✅ Age public key consistency"
          echo "  ✅ git-secrets scan"
          echo ""
          echo "Note: Full decryption test requires password and should be run locally."
          echo "See: scripts/validate-encryption.sh"
