name: Validate

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck on .sh files
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: '.'
          severity: warning
          # Only check .sh files (exclude .sh.tmpl as they contain chezmoi template syntax)
          ignore_paths: '*.tmpl'

  shellcheck-templates:
    name: ShellCheck Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: |
          CHEZMOI_VERSION="2.67.0"
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin" "v${CHEZMOI_VERSION}"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Initialize chezmoi
        run: |
          chezmoi init --source="$GITHUB_WORKSPACE"

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Render and validate template scripts
        run: |
          set -e
          # Find all .sh.tmpl files
          TEMPLATE_FILES=$(find . -name "*.sh.tmpl" -type f)

          if [ -z "$TEMPLATE_FILES" ]; then
            echo "No template files found"
            exit 0
          fi

          # Create temporary directory for rendered templates
          TEMP_DIR=$(mktemp -d)
          trap 'rm -rf "$TEMP_DIR"' EXIT

          # Render each template and validate with shellcheck
          for template in $TEMPLATE_FILES; do
            echo "Validating template: $template"
            # Get the target path (remove leading ./)
            target_path="${template#./}"
            # Remove .tmpl extension for the rendered file
            rendered_file="$TEMP_DIR/${target_path%.tmpl}"

            # Create directory structure
            mkdir -p "$(dirname "$rendered_file")"

            # Render template (this will fail if template syntax is invalid)
            ERROR_OUTPUT=$(chezmoi execute-template < "$template" 2>&1 > "$rendered_file") && RENDER_SUCCESS=true || RENDER_SUCCESS=false

            if [ "$RENDER_SUCCESS" = "false" ]; then
              # Check if it's a template syntax error or missing data
              if echo "$ERROR_OUTPUT" | grep -q "template:"; then
                echo "ERROR: Template syntax error in $template"
                echo "$ERROR_OUTPUT"
                exit 1
              else
                echo "Warning: Could not render $template (may require data unavailable in CI)"
                echo "$ERROR_OUTPUT"
                continue
              fi
            fi

            # Validate rendered file with shellcheck
            if [ -s "$rendered_file" ]; then
              shellcheck "$rendered_file" || {
                echo "ERROR: ShellCheck failed for rendered template: $template"
                exit 1
              }
            fi
          done

          echo "All template validations passed"

  chezmoi-verify:
    name: Chezmoi Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install chezmoi
        run: |
          CHEZMOI_VERSION="2.67.0"
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin" "v${CHEZMOI_VERSION}"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify chezmoi installation
        run: |
          chezmoi --version

      - name: Initialize chezmoi
        run: |
          chezmoi init --source="$GITHUB_WORKSPACE"

      - name: Run chezmoi doctor (informational)
        continue-on-error: true
        run: |
          echo "Running chezmoi doctor for informational purposes..."
          chezmoi doctor

      - name: Validate all templates can be parsed
        run: |
          set -e
          echo "Checking if all template files have valid syntax..."
          FAILED=0

          # Use process substitution to avoid subshell issue with while loop
          while IFS= read -r template; do
            echo "Checking template syntax: $template"
            # This will fail if there are Go template syntax errors
            if ! ERROR_OUTPUT=$(chezmoi execute-template < "$template" 2>&1 > /dev/null); then
              echo "ERROR: Template syntax error in: $template"
              echo "Error details:"
              echo "$ERROR_OUTPUT"
              FAILED=1
            fi
          done < <(find . -name "*.tmpl" -type f)

          if [ "$FAILED" -eq 1 ]; then
            echo "Template validation failed"
            exit 1
          fi

          echo "All templates have valid syntax"
